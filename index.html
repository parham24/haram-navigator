<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>نقشه حرم</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff" />

    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Vazirmatn', Tahoma, sans-serif;
        }
        #app-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #eee; }
        
        #panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background-color: white;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%); /* >> حالت اولیه: کاملا مخفی << */
            z-index: 1000;
        }
        #panel.visible {
            transform: translateY(0);
        }
        #panel-content { 
            padding: 16px; 
            max-height: 90vh; 
            overflow-y: auto;
            text-align: center;
        }
        .controls { display: flex; flex-direction: column; gap: 12px; margin-top: 16px;}
        button {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #ddd;
            font-family: inherit; font-size: 16px; background-color: #0b6; color: white;
            cursor: pointer; font-weight: bold;
        }
        button.secondary { background-color: #777; }
        h3 { margin-top: 0; margin-bottom: 8px; }
        p { margin: 0; color: #555; }

        .leaflet-routing-container { display: none !important; }
        .user-marker {
            width: 20px; height: 20px; background-color: #007aff;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>
    <div id="panel">
        <div id="panel-content"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
    const places = [
      { id:'sahn_enqelab', type:'صحن', name:'صحن انقلاب (عتیق)', lat:36.28805, lon:59.61560},
      { id:'sahn_azadi', type:'صحن', name:'صحن آزادی', lat:36.28860, lon:59.61630},
      { id:'sahn_jamee', type:'صحن', name:'صحن جامع رضوی', lat:36.2872, lon:59.6151},
      { id:'sahn_jomhuri', type:'صحن', name:'صحن جمهوری اسلامی', lat:36.28790, lon:59.6145},
      { id:'sahn_qods', type:'صحن', name:'صحن قدس', lat:36.28750, lon:59.61520},
      { id:'ravaq_imam_khomeini', type:'رواق', name:'رواق امام خمینی', lat:36.2876, lon:59.6155},
      { id:'bab_ol_reza', type:'باب', name:'باب‌الرضا (ورودی جنوبی)', lat:36.2868, lon:59.6150},
      { id:'golden_dome', type:'ضریح', name:'ضریح مطهر', lat:36.28805, lon:59.6157},
    ];

    const map = L.map('map', {zoomControl: false}).setView([36.28805, 59.6157], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution: '© OpenStreetMap'}).addTo(map);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    const panel = document.getElementById('panel');
    const panelContent = document.getElementById('panel-content');
    let currentRouteControl = null;
    let selectionMarker = null;

    // >> راه حل ۱: فعال کردن لمس روی نقشه <<
    map.on('click', onMapClick);

    function onMapClick(e) {
        clearRoute();
        const tappedPoint = e.latlng;
        
        if (selectionMarker) {
            selectionMarker.setLatLng(tappedPoint);
        } else {
            selectionMarker = L.circleMarker(tappedPoint, {
                color: '#007aff',
                fillColor: '#007aff',
                fillOpacity: 0.8,
                radius: 8
            }).addTo(map);
        }
        
        const nearestPlace = findNearestPlace(tappedPoint);
        renderTappedLocationView(tappedPoint, nearestPlace);
    }

    // >> راه حل ۲: پیدا کردن نزدیک‌ترین مکان <<
    function findNearestPlace(tappedPoint) {
        let closestPlace = null;
        let minDistance = Infinity;

        places.forEach(place => {
            const placeLatLng = L.latLng(place.lat, place.lon);
            const distance = tappedPoint.distanceTo(placeLatLng);
            if (distance < minDistance) {
                minDistance = distance;
                closestPlace = place;
            }
        });

        // فقط اگر فاصله کمتر از یک حد معقول (مثلا ۷۰ متر) بود، آن را برگردان
        return minDistance < 70 ? closestPlace : null;
    }

    // >> راه حل ۳: نمایش پنل جدید <<
    function renderTappedLocationView(tappedPoint, nearestPlace) {
        const title = nearestPlace ? nearestPlace.name : "نقطه انتخاب شده";
        const subtitle = nearestPlace ? `(${nearestPlace.type})` : "روی نقشه";

        panelContent.innerHTML = `
            <h3>${title}</h3>
            <p>${subtitle}</p>
            <div class="controls">
                <button id="route-to-btn">مسیر به اینجا</button>
                <button id="route-from-btn" class="secondary">مسیر از اینجا</button>
            </div>
        `;
        
        document.getElementById('route-to-btn').addEventListener('click', () => {
            showRoute({ lat: tappedPoint.lat, lon: tappedPoint.lng }, 'to');
        });
        document.getElementById('route-from-btn').addEventListener('click', () => {
            showRoute({ lat: tappedPoint.lat, lon: tappedPoint.lng }, 'from');
        });

        panel.classList.add('visible');
    }

    function hidePanel() {
        panel.classList.remove('visible');
        if(selectionMarker) {
            map.removeLayer(selectionMarker);
            selectionMarker = null;
        }
    }

    async function showRoute(tappedLocation, direction) {
        clearRoute();
        panelContent.innerHTML = `<p>در حال دریافت موقعیت و محاسبه مسیر...</p>`;
        
        try {
            const userLocation = await getPosition();
            const userPoint = [userLocation.lat, userLocation.lon];
            const tappedPoint = [tappedLocation.lat, tappedLocation.lon];
            
            const startPoint = direction === 'from' ? tappedPoint : userPoint;
            const endPoint = direction === 'to' ? tappedPoint : userPoint;
            
            currentRouteControl = L.Routing.control({
                waypoints: [L.latLng(startPoint), L.latLng(endPoint)],
                addWaypoints: false,
                createMarker: () => null, // مارکرهای پیش‌فرض را غیرفعال می‌کنیم
                lineOptions: { styles: [{ color: '#c00', opacity: 0.9, weight: 6 }] }
            }).addTo(map);
            
            hidePanel();

        } catch (err) {
            panelContent.innerHTML = `<p style="color:red"><b>خطا:</b> ${err.message}</p>`;
        }
    }

    function clearRoute() {
        if (currentRouteControl) {
            map.removeControl(currentRouteControl);
            currentRouteControl = null;
        }
    }

    async function getPosition(){
      if (!navigator.geolocation) throw new Error('موقعیت‌یاب پشتیبانی نمی‌شود.');
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => {
            let msg = 'خطا در دریافت موقعیت.';
            if (err.code === 1) msg = 'شما دسترسی به موقعیت را مسدود کرده‌اید.';
            if (err.code === 2) msg = 'سرویس موقعیت‌یاب (GPS) دستگاه شما خاموش است.';
            if (err.code === 3) msg = 'زمان درخواست به پایان رسید.';
            reject(new Error(msg));
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // --- ثبت سرویس ورکر ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => console.log('سرویس ورکر ثبت شد.')).catch(err => console.log('خطا:', err));
      });
    }
</script>

</body>
</html>
