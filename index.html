<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 100vh; }
        body { margin: 0; padding: 0; }
        #info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: white; 
            padding: 10px; 
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="info">Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Ù†Ù‚Ø´Ù‡ Ø³Ø§Ø¯Ù‡
        const map = L.map('map').setView([36.28805, 59.6157], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let startPoint = null;
        let endPoint = null;
        let routeLayer = null;

        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ - Ù†Ù‚Ø·Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        map.on('click', function(e) {
            // Ø­Ø°Ù marker Ù‚Ø¨Ù„ÛŒ
            if (endPoint) {
                map.removeLayer(endPoint);
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ marker Ø¬Ø¯ÛŒØ¯
            endPoint = L.marker(e.latlng).addTo(map)
                .bindPopup('Ù†Ù‚Ø·Ù‡ Ù…Ù‚ØµØ¯')
                .openPopup();
            
            // Ø§Ú¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ù…Ø³ÛŒØ± Ø±Ø§ Ø±Ø³Ù… Ú©Ù†
            if (startPoint) {
                calculateRoute(startPoint.getLatLng(), e.latlng);
            }
        });

        // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± (Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹)
        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLatLng = [
                        position.coords.latitude,
                        position.coords.longitude
                    ];
                    
                    // Ø­Ø°Ù marker Ù‚Ø¨Ù„ÛŒ
                    if (startPoint) {
                        map.removeLayer(startPoint);
                    }
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ marker Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
                    startPoint = L.marker(userLatLng).addTo(map)
                        .bindPopup('Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§')
                        .openPopup();
                    
                    // Ø­Ø±Ú©Øª Ù†Ù‚Ø´Ù‡ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
                    map.setView(userLatLng, 16);
                    
                    // Ø§Ú¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ù‚ØµØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ù…Ø³ÛŒØ± Ø±Ø§ Ø±Ø³Ù… Ú©Ù†
                    if (endPoint) {
                        calculateRoute(userLatLng, endPoint.getLatLng());
                    }
                },
                function(error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000
                }
            );
        }

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø±Ø³Ù… Ù…Ø³ÛŒØ±
        function calculateRoute(start, end) {
            // Ø­Ø°Ù Ù…Ø³ÛŒØ± Ù‚Ø¨Ù„ÛŒ
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø· Ù…Ø³ÛŒØ±
            routeLayer = L.polyline([start, end], {
                color: 'red',
                weight: 6,
                opacity: 0.7
            }).addTo(map);
            
            // ØªÙ†Ø¸ÛŒÙ… Ù†Ù…Ø§ÛŒ Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ù„ Ù…Ø³ÛŒØ±
            map.fitBounds(routeLayer.getBounds());
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡
            const distance = map.distance(start, end);
            document.getElementById('info').innerHTML = 
                `ÙØ§ØµÙ„Ù‡: ${Math.round(distance)} Ù…ØªØ±`;
        }

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
        const locateButton = L.control({position: 'topright'});
        locateButton.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'locate-btn');
            div.innerHTML = '<button style="padding:10px; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>';
            div.onclick = getUserLocation;
            return div;
        };
        locateButton.addTo(map);

        // Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±
        const clearButton = L.control({position: 'topright'});
        clearButton.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'clear-btn');
            div.innerHTML = '<button style="padding:10px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer; margin-top:10px;">âŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>';
            div.onclick = function() {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                if (endPoint) {
                    map.removeLayer(endPoint);
                    endPoint = null;
                }
                document.getElementById('info').innerHTML = 'Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯';
            };
            return div;
        };
        clearButton.addTo(map);

        // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        getUserLocation();
    </script>
</body>
</html>
