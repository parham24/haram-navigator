<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست مسیریابی</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 100vh; }
        body { margin: 0; padding: 0; }
        #info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: white; 
            padding: 10px; 
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="info">روی نقشه کلیک کنید سپس دکمه مسیریابی را بزنید</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // نقشه ساده
        const map = L.map('map').setView([36.28805, 59.6157], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let startPoint = null;
        let endPoint = null;
        let routeLayer = null;

        // کلیک روی نقشه - نقطه پایان را تنظیم می‌کند
        map.on('click', function(e) {
            // حذف marker قبلی
            if (endPoint) {
                map.removeLayer(endPoint);
            }
            
            // ایجاد marker جدید
            endPoint = L.marker(e.latlng).addTo(map)
                .bindPopup('نقطه مقصد')
                .openPopup();
            
            // اگر موقعیت کاربر وجود دارد، مسیر را رسم کن
            if (startPoint) {
                calculateRoute(startPoint.getLatLng(), e.latlng);
            }
        });

        // دریافت موقعیت کاربر (نقطه شروع)
        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLatLng = [
                        position.coords.latitude,
                        position.coords.longitude
                    ];
                    
                    // حذف marker قبلی
                    if (startPoint) {
                        map.removeLayer(startPoint);
                    }
                    
                    // ایجاد marker برای موقعیت کاربر
                    startPoint = L.marker(userLatLng).addTo(map)
                        .bindPopup('موقعیت شما')
                        .openPopup();
                    
                    // حرکت نقشه به موقعیت کاربر
                    map.setView(userLatLng, 16);
                    
                    // اگر نقطه مقصد وجود دارد، مسیر را رسم کن
                    if (endPoint) {
                        calculateRoute(userLatLng, endPoint.getLatLng());
                    }
                },
                function(error) {
                    alert('خطا در دریافت موقعیت: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000
                }
            );
        }

        // محاسبه و رسم مسیر
        function calculateRoute(start, end) {
            // حذف مسیر قبلی
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // ایجاد خط مسیر
            routeLayer = L.polyline([start, end], {
                color: 'red',
                weight: 6,
                opacity: 0.7
            }).addTo(map);
            
            // تنظیم نمای نقشه برای نمایش کل مسیر
            map.fitBounds(routeLayer.getBounds());
            
            // محاسبه فاصله
            const distance = map.distance(start, end);
            document.getElementById('info').innerHTML = 
                `فاصله: ${Math.round(distance)} متر`;
        }

        // دکمه برای دریافت موقعیت کاربر
        const locateButton = L.control({position: 'topright'});
        locateButton.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'locate-btn');
            div.innerHTML = '<button style="padding:10px; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer;">📍 موقعیت من</button>';
            div.onclick = getUserLocation;
            return div;
        };
        locateButton.addTo(map);

        // دکمه برای پاک کردن مسیر
        const clearButton = L.control({position: 'topright'});
        clearButton.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'clear-btn');
            div.innerHTML = '<button style="padding:10px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer; margin-top:10px;">❌ پاک کردن</button>';
            div.onclick = function() {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                if (endPoint) {
                    map.removeLayer(endPoint);
                    endPoint = null;
                }
                document.getElementById('info').innerHTML = 'روی نقشه کلیک کنید';
            };
            return div;
        };
        clearButton.addTo(map);

        // دریافت موقعیت کاربر به طور خودکار هنگام لود صفحه
        getUserLocation();
    </script>
</body>
</html>
