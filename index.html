<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>نقشه حرم</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* جلوگیری از اسکرول کل صفحه */
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background-color: #f0f2f5;
        }
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateY(calc(100% - 80px)); /* حالت اولیه بسته */
            z-index: 1000;
        }
        #panel.expanded {
            transform: translateY(0);
        }
        #panel-handle {
            padding: 12px;
            text-align: center;
            cursor: grab;
            border-bottom: 1px solid #eee;
        }
        #panel-handle::before {
            content: '';
            display: inline-block;
            width: 40px;
            height: 5px;
            background-color: #ccc;
            border-radius: 3px;
        }
        #panel-content {
            padding: 16px;
            max-height: calc(100vh - 80px); /* ارتفاع حداکثری پنل */
            overflow-y: auto;
        }
        .controls { display: flex; flex-direction: column; gap: 12px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        select, button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 15px;
            background-color: #f7f7f7;
        }
        button { background-color: #0b6; color: white; border: none; cursor: pointer; }
        button#clear-btn { background-color: #777; }
        #swapBtn { width: 42px; flex-shrink: 0; padding: 8px; font-size: 20px; }
        .details-box h3 { margin-top: 0; }
        .route-summary { text-align: center; }
        .route-summary strong { font-size: 1.2em; }
        .leaflet-routing-container { display: none !important; } /* مخفی کردن پنل انگلیسی */
    </style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>

    <div id="panel">
        <div id="panel-handle"></div>
        <div id="panel-content">
            <!-- محتوای پنل به صورت داینامیک اینجا قرار می‌گیرد -->
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
    const places = [
      { id:'sahn_enqelab', type:'صحن', name:'صحن انقلاب (عتیق)', lat:36.28805, lon:59.61560},
      { id:'sahn_azadi', type:'صحن', name:'صحن آزادی', lat:36.28860, lon:59.61630},
      { id:'sahn_jamee', type:'صحن', name:'صحن جامع رضوی', lat:36.2872, lon:59.6151},
      { id:'sahn_jomhuri', type:'صحن', name:'صحن جمهوری اسلامی', lat:36.28790, lon:59.6145},
      { id:'sahn_qods', type:'صحن', name:'صحن قدس', lat:36.28750, lon:59.61520},
      { id:'ravaq_imam_khomeini', type:'رواق', name:'رواق امام خمینی', lat:36.2876, lon:59.6155},
      { id:'bab_ol_reza', type:'باب', name:'باب‌الرضا (ورودی جنوبی)', lat:36.2868, lon:59.6150},
      { id:'golden_dome', type:'ضریح', name:'ضریح مطهر', lat:36.28805, lon:59.6157},
    ];

    const map = L.map('map', {zoomControl: false}).setView([36.28805, 59.6157], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution: '© OpenStreetMap'}).addTo(map);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    let currentRouteControl = null;
    const panel = document.getElementById('panel');
    const panelContent = document.getElementById('panel-content');
    const panelHandle = document.getElementById('panel-handle');
    
    panelHandle.addEventListener('click', () => panel.classList.toggle('expanded'));

    function renderInitialView() {
        panelContent.innerHTML = `
            <div class="controls">
                <div class="control-group">
                    <select id="start"></select>
                    <button id="swapBtn">⇄</button>
                    <select id="end"></select>
                </div>
                <button id="go-btn">نمایش مسیر</button>
            </div>
            <hr>
            <div id="places-list"></div>
        `;
        const startSel = document.getElementById('start');
        const endSel = document.getElementById('end');
        addOptions(startSel);
        addOptions(endSel);
        renderPlacesList();

        document.getElementById('go-btn').addEventListener('click', showRoute);
        document.getElementById('swapBtn').addEventListener('click', () => {
            const temp = startSel.value;
            startSel.value = endSel.value;
            endSel.value = temp;
        });
        panel.classList.remove('expanded');
    }

    function addOptions(sel) {
        sel.innerHTML = '<option value="__me">موقعیت فعلی من</option>';
        places.forEach(p => {
            const o = document.createElement('option');
            o.value = p.id;
            o.textContent = p.name;
            sel.appendChild(o);
        });
    }

    function renderPlacesList() {
        const listEl = document.getElementById('places-list');
        listEl.innerHTML = places.map(p => `
            <div class="place" data-id="${p.id}">
                <h4>${p.name} <small style="color:#888;">(${p.type})</small></h4>
            </div>
        `).join('');
        
        listEl.querySelectorAll('.place').forEach(el => {
            el.addEventListener('click', () => {
                const place = places.find(p => p.id === el.dataset.id);
                map.setView([place.lat, place.lon], 19);
                renderDetailsView(place);
            });
        });
    }

    function renderDetailsView(place) {
        panelContent.innerHTML = `
            <div class="details-box">
                <button id="back-btn" style="background:none; border:none; color:#555; padding:0; width:auto; font-size: 16px;">&larr; بازگشت به لیست</button>
                <h3>${place.name}</h3>
                <p>نوع مکان: ${place.type}</p>
                <div class="controls">
                    <button class="dir-btn" data-type="to" data-id="${place.id}">مسیریابی به اینجا</button>
                    <button class="dir-btn" data-type="from" data-id="${place.id}" style="background-color:#555">مسیریابی از اینجا</button>
                </div>
            </div>
        `;
        panel.classList.add('expanded');
        document.getElementById('back-btn').addEventListener('click', renderInitialView);
        document.querySelectorAll('.dir-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const { type, id } = e.target.dataset;
                if(type === 'to') {
                    document.getElementById('start').value = '__me';
                    document.getElementById('end').value = id;
                } else {
                    document.getElementById('start').value = id;
                    document.getElementById('end').value = '__me';
                }
                showRoute();
            });
        });
    }

    function renderRouteSummary(summary) {
        const distance = summary.totalDistance < 1000 ? 
            `${Math.round(summary.totalDistance).toLocaleString('fa-IR')} متر` : 
            (summary.totalDistance / 1000).toLocaleString('fa-IR', {maximumFractionDigits: 1}) + ' کیلومتر';
        const time = Math.round(summary.totalTime / 60).toLocaleString('fa-IR');

        panelContent.innerHTML = `
            <div class="route-summary">
                <p>فاصله: <strong>${distance}</strong></p>
                <p>زمان پیاده‌روی: <strong>حدود ${time} دقیقه</strong></p>
                <button id="clear-btn">پاک کردن مسیر</button>
            </div>
        `;
        document.getElementById('clear-btn').addEventListener('click', clearRoute);
        panel.classList.remove('expanded'); // بستن پنل برای نمایش نقشه
    }

    function displayError(message, isLocationError = false) {
        panelContent.innerHTML = `<p style="color:red; text-align:center;"><strong>خطا:</strong> ${message}</p>`;
        if (isLocationError) {
            panelContent.innerHTML += `<div class="controls"><button id="retryBtn">تلاش مجدد</button></div>`;
            document.getElementById('retryBtn').addEventListener('click', showRoute);
        }
        panel.classList.add('expanded');
    }

    async function showRoute() {
        const startVal = document.getElementById('start').value;
        const endVal = document.getElementById('end').value;
        if (startVal === endVal) { displayError('مبدا و مقصد یکسان است.'); return; }

        clearRoute(true);
        panelContent.innerHTML = `<p style="text-align:center;">در حال محاسبه مسیر...</p>`;
        panel.classList.add('expanded');

        let startPoint, endPoint;
        try {
            let userLocation = null;
            if (startVal === '__me' || endVal === '__me') {
                userLocation = await getPosition();
            }
            startPoint = (startVal === '__me') ? [userLocation.lat, userLocation.lon] : [places.find(p=>p.id===startVal).lat, places.find(p=>p.id===startVal).lon];
            endPoint = (endVal === '__me') ? [userLocation.lat, userLocation.lon] : [places.find(p=>p.id===endVal).lat, places.find(p=>p.id===endVal).lon];
        } catch (err) {
            displayError(err.message, true);
            return;
        }
      
        currentRouteControl = L.Routing.control({
            waypoints: [L.latLng(startPoint), L.latLng(endPoint)],
            addWaypoints: false, createMarker: () => null,
            lineOptions: { styles: [{ color: '#c00', opacity: 0.9, weight: 6 }] }
        }).addTo(map);
      
        currentRouteControl.on('routesfound', e => renderRouteSummary(e.routes[0].summary));
        currentRouteControl.on('routingerror', () => displayError("مسیریابی ممکن نبود. اتصال اینترنت را بررسی کنید."));
    }

    function clearRoute(isRouting = false) {
        if (currentRouteControl) {
            map.removeControl(currentRouteControl);
            currentRouteControl = null;
        }
        if (!isRouting) {
            renderInitialView();
        }
    }
    
    async function getPosition() { /* ... همان کد قبلی ... */ }
    // (کد تابع getPosition از پاسخ قبلی را اینجا کپی کنید)
    async function getPosition(){
      if (!navigator.geolocation) throw { code: -1, message: 'موقعیت‌یاب پشتیبانی نمی‌شود.' };
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => {
            let msg = 'خطا در دریافت موقعیت.';
            if (err.code === 1) msg = 'شما دسترسی به موقعیت را مسدود کرده‌اید.';
            if (err.code === 2) msg = 'سرویس موقعیت‌یاب (GPS) دستگاه شما خاموش است.';
            if (err.code === 3) msg = 'زمان درخواست به پایان رسید.';
            reject({ code: err.code, message: msg });
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // --- اجرای اولیه برنامه ---
    renderInitialView();

    // --- ثبت سرویس ورکر ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => console.log('سرویس ورکر ثبت شد.')).catch(err => console.log('خطا:', err));
      });
    }
</script>

</body>
</html>```

#### ۲. فایل `manifest.json` (بدون تغییر)

```json
{
  "name": "راهنمای حرم امام رضا",
  "short_name": "نقشه حرم",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#ffffff",
  "description": "مسیریاب داخلی و آفلاین حرم مطهر رضوی.",
  "icons": [
    {
      "src": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Imam_Reza_shrine_logo.svg/192px-Imam_Reza_shrine_logo.svg.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Imam_Reza_shrine_logo.svg/512px-Imam_Reza_shrine_logo.svg.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
