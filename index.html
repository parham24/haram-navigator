<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>نقشه حرم</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<meta name="theme-color" content="#ffffff" />

<style>
html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Vazirmatn', Tahoma, sans-serif; }
#app-container { position: relative; width: 100%; height: 100%; }
#map { width: 100%; height: 100%; background: #eee; }

#panel {
    position: absolute; bottom: 0; left: 0; right: 0;
    background-color: white; border-top-left-radius: 16px; border-top-right-radius: 16px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    transition: transform 0.3s ease-in-out; transform: translateY(100%);
    z-index: 1000;
}
#panel.visible { transform: translateY(0); }
#panel-content { padding: 16px; max-height: 90vh; overflow-y: auto; text-align: center; }
.controls { display: flex; flex-direction: column; gap: 12px; margin-top: 16px;}
button {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    font-family: inherit; font-size: 16px; background-color: #0b6; color: white;
    cursor: pointer; font-weight: bold;
}
button.secondary { background-color: #777; }
h3 { margin-top: 0; margin-bottom: 8px; }
p { margin: 0; color: #555; }

#locate-btn {
    position: absolute; bottom: 20px; right: 20px;
    width: 50px; height: 50px; background-color: white;
    border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 1000; display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: none;
}
#locate-btn svg { width: 24px; height: 24px; fill: #333; }
.user-marker {
    width: 20px; height: 20px; background-color: #007aff;
    border: 3px solid white; border-radius: 50%;
    box-shadow: 0 0 8px rgba(0,0,0,0.5);
}
</style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>
    <div id="panel">
        <div id="panel-content"></div>
    </div>
    <button id="locate-btn" title="مکان فعلی من">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
/* === داده‌ها (کلید lng بجای lon برای یکنواختی) === */
const places = [
  { id:'sahn_enqelab', type:'صحن', name:'صحن انقلاب', lat:36.28805, lng:59.61560},
  { id:'sahn_azadi', type:'صحن', name:'صحن آزادی', lat:36.28860, lng:59.61630},
  { id:'sahn_jamee', type:'صحن', name:'صحن جامع رضوی', lat:36.2872, lng:59.6151},
  { id:'sahn_jomhuri', type:'صحن', name:'صحن جمهوری', lat:36.28790, lng:59.6145},
  { id:'sahn_qods', type:'صحن', name:'صحن قدس', lat:36.28750, lng:59.61520},
  { id:'ravaq_imam', type:'رواق', name:'رواق امام خمینی', lat:36.2876, lng:59.6155},
  { id:'golden_dome', type:'ضریح', name:'ضریح مطهر', lat:36.28805, lng:59.6157},
  { id:'bab_reza', type:'باب', name:'باب‌الرضا (ورودی جنوبی)', lat:36.2868, lng:59.6150},
  { id:'bab_javad', type:'باب', name:'باب‌الجواد (ورودی غربی)', lat:36.2874, lng:59.6144},
  { id:'bab_tabarsi', type:'باب', name:'ورودی طبرسی (شمالی)', lat:36.2895, lng:59.615},
  { id:'bab_shirazi', type:'باب', name:'ورودی شیرازی (شمال غربی)', lat:36.2888, lng:59.6143},
];

const edges = [
  ['golden_dome', 'sahn_enqelab'], ['sahn_enqelab', 'sahn_azadi'], ['sahn_enqelab', 'sahn_jomhuri'],
  ['sahn_azadi', 'sahn_jamee'], ['sahn_jomhuri', 'sahn_jamee'], ['sahn_jomhuri', 'sahn_qods'],
  ['sahn_qods', 'sahn_jamee'], ['sahn_qods', 'ravaq_imam'], ['ravaq_imam', 'sahn_jamee'],
  ['sahn_jamee', 'bab_reza'], ['sahn_jamee', 'bab_javad'], ['sahn_jomhuri', 'bab_shirazi'],
  ['sahn_enqelab', 'bab_tabarsi']
];

/* === نقشه و عناصر UI === */
const map = L.map('map', {zoomControl: false}).setView([36.28805, 59.6157], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20}).addTo(map);
L.control.zoom({ position: 'topleft' }).addTo(map);

const panel = document.getElementById('panel');
const panelContent = document.getElementById('panel-content');
const locateBtn = document.getElementById('locate-btn');
const routeLayers = L.layerGroup().addTo(map);
let selectionMarker = null, userMarker = null;

map.on('click', onMapClick);
locateBtn.addEventListener('click', locateUser);

/* === helper: نرمال‌سازی هر نوع ورودی به L.LatLng === */
function normalizeLatLng(input) {
  try {
    if (!input && input !== 0) return null;
    // اگر از قبل L.LatLng است
    if (input instanceof L.LatLng) return input;
    // آرایه [lat,lng]
    if (Array.isArray(input) && input.length >= 2) return L.latLng(input[0], input[1]);
    // شی با کلید‌های lat & lng یا lat & lon
    if (typeof input === 'object') {
      const lat = input.lat ?? input.latitude ?? input[0];
      const lng = input.lng ?? input.lon ?? input.longitude ?? input[1];
      if (typeof lat === 'number' && typeof lng === 'number') return L.latLng(lat, lng);
    }
    return null;
  } catch (e) {
    console.error('normalizeLatLng error:', e);
    return null;
  }
}

/* === مسیر یابی و نمایش مسیرها === */
async function showRoute(tappedLocation, direction) {
  clearAll();
  panelContent.innerHTML = `<p>در حال محاسبه مسیر...</p>`;
  panel.classList.add('visible');

  try {
    const userLocationObj = await getPosition(); // {lat, lng}
    const userLatLng = normalizeLatLng(userLocationObj);
    const tappedLatLng = normalizeLatLng(tappedLocation);

    if (!userLatLng) throw new Error('مکان کاربر قابل دریافت نیست.');
    if (!tappedLatLng) throw new Error('مختصات نقطه انتخاب شده معتبر نیست.');

    const userIsInside = !!findNearestPlace(userLatLng, 20);
    const tappedIsInside = !!findNearestPlace(tappedLatLng);

    const startLatLng = (direction === 'from') ? tappedLatLng : userLatLng;
    const endLatLng = (direction === 'to') ? tappedLatLng : userLatLng;

    if (userIsInside && tappedIsInside) {
      const startPlace = findNearestPlace(startLatLng);
      const endPlace = findNearestPlace(endLatLng);
      if (!startPlace || !endPlace) throw new Error('مکان داخلی پیدا نشد.');
      drawInternalPath(startPlace.id, endPlace.id);
    } else if (!normalizeLatLng(startLatLng) || !normalizeLatLng(endLatLng)) {
      throw new Error('مختصات شروع یا پایان نامعتبر است.');
    } else if (!userIsInside && tappedIsInside) {
      const nearestEntrance = findNearestEntrance(startLatLng);
      const endPlace = findNearestPlace(endLatLng);
      if (!nearestEntrance || !endPlace) throw new Error('ورودی نزدیک پیدا نشد.');
      await drawExternalPath([startLatLng.lat, startLatLng.lng], [nearestEntrance.lat, nearestEntrance.lng]);
      drawInternalPath(nearestEntrance.id, endPlace.id, true);
    } else {
      await drawExternalPath([startLatLng.lat, startLatLng.lng], [endLatLng.lat, endLatLng.lng]);
    }

    hidePanel(true);
  } catch (err) {
    console.error('showRoute error:', err);
    panelContent.innerHTML = `<p style="color:red"><b>خطا:</b> ${err.message}</p>`;
  }
}

function drawExternalPath(startLatLngArr, endLatLngArr) {
  return new Promise((resolve, reject) => {
    try {
      const router = L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: 'foot' });
      const wps = [
        L.latLng(startLatLngArr[0], startLatLngArr[1]),
        L.latLng(endLatLngArr[0], endLatLngArr[1])
      ];
      router.route(wps, (err, routes) => {
        if (err) { reject(new Error("مسیریابی آنلاین ممکن نبود.")); return; }
        if (routes && routes.length > 0) {
          const line = L.Routing.line(routes[0], { styles: [{ color: '#c00', opacity: 0.9, weight: 6 }] });
          routeLayers.addLayer(line);
          map.fitBounds(line.getBounds(), {padding: [50,50]});
          resolve();
        } else { reject(new Error("هیچ مسیری یافت نشد.")); }
      });
    } catch (e) {
      reject(e);
    }
  });
}

function drawInternalPath(startId, endId, isDashed = false) {
  const path = findShortestPath(startId, endId);
  if (path && path.length) {
    const latlngs = path.map(id => {
      const p = places.find(x => x.id === id);
      return [p.lat, p.lng];
    });
    const options = { color: '#c00', weight: 6, opacity: 0.8 };
    if (isDashed) options.dashArray = '10, 10';
    const polyline = L.polyline(latlngs, options).addTo(routeLayers);
    map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
  } else {
    console.warn('مسیر داخلی پیدا نشد بین', startId, endId);
  }
}

/* === گراف و کوتاه‌ترین مسیر ساده (BFS) === */
function findShortestPath(startId, endId) {
  const adj = {}; places.forEach(p => adj[p.id] = []);
  edges.forEach(([u, v]) => { adj[u].push(v); adj[v].push(u); });
  const queue = [[startId]]; const visited = new Set([startId]);
  while (queue.length > 0) {
    const path = queue.shift();
    const node = path[path.length - 1];
    if (node === endId) return path;
    for (const neighbor of adj[node] || []) {
      if (!visited.has(neighbor)) { visited.add(neighbor); queue.push([...path, neighbor]); }
    }
  }
  return null;
}

/* === جستجوی نزدیک‌ترین مکان (پذیرش L.LatLng یا آرایه یا شی) === */
function findNearestPlace(pointInput, threshold = 70) {
  const point = normalizeLatLng(pointInput);
  if (!point) return null;
  let closest = null, minDistance = Infinity;
  places.forEach(place => {
    const distance = point.distanceTo(L.latLng(place.lat, place.lng));
    if (distance < minDistance) { minDistance = distance; closest = place; }
  });
  return minDistance < threshold ? closest : null;
}

/* === پیدا کردن نزدیک‌ترین ورودی (باب) === */
function findNearestEntrance(pointInput) {
  const point = normalizeLatLng(pointInput);
  if (!point) return null;
  const entrances = places.filter(p => p.type === 'باب');
  let closest = null, minDistance = Infinity;
  entrances.forEach(entrance => {
    const distance = point.distanceTo(L.latLng(entrance.lat, entrance.lng));
    if (distance < minDistance) { minDistance = distance; closest = entrance; }
  });
  return closest;
}

/* === پاک‌سازی مسیرها و مارکر انتخاب شده === */
function clearAll() {
  routeLayers.clearLayers();
  if (selectionMarker) { map.removeLayer(selectionMarker); selectionMarker = null; }
}

/* === یافتن مکان کاربر و نمایش آن === */
async function locateUser() {
  try {
    const userLocation = await getPosition(); // {lat, lng}
    const latlng = [userLocation.lat, userLocation.lng];
    if (!userMarker) {
      const userIcon = L.divIcon({ className: 'user-marker' });
      userMarker = L.marker(latlng, { icon: userIcon }).addTo(map);
    }
    userMarker.setLatLng(latlng);
    map.flyTo(latlng, 18);
    hidePanel();
  } catch (err) {
    console.error('locateUser error:', err);
    panel.classList.add('visible');
    panelContent.innerHTML = `<p style="color:red"><b>خطا:</b> ${err.message}</p>`;
  }
}

/* === کلیک روی نقشه === */
function onMapClick(e) {
  clearAll();
  const tappedPoint = e && e.latlng ? e.latlng : null;
  if (!tappedPoint) { console.warn('رویداد کلیک بدون latlng'); return; }
  selectionMarker = L.circleMarker(tappedPoint, { color: '#007aff', fillColor: '#007aff', fillOpacity: 0.8, radius: 8 }).addTo(map);
  const nearestPlace = findNearestPlace(tappedPoint);
  renderTappedLocationView(tappedPoint, nearestPlace);
}

/* === نمایش پنل برای نقطه انتخاب شده === */
function renderTappedLocationView(tappedPoint, nearestPlace) {
  const normalized = normalizeLatLng(tappedPoint);
  const title = nearestPlace ? nearestPlace.name : (normalized ? "نقطه انتخاب شده" : "نقطه نامعتبر");
  panelContent.innerHTML = `<h3>${title}</h3>
  <div class="controls">
    <button id="route-to-btn">مسیر به اینجا</button>
    <button id="route-from-btn" class="secondary">مسیر از اینجا</button>
    <button id="cancel-btn" class="secondary" style="background-color: #cc0000;">انصراف</button>
  </div>`;

  // همیشه از selectionMarker.getLatLng() استفاده کن تا مطمئن باشیم L.LatLng داریم
  const clickLatLngForHandlers = (selectionMarker && selectionMarker.getLatLng()) ? selectionMarker.getLatLng() : normalized;

  document.getElementById('route-to-btn').addEventListener('click', () => showRoute(clickLatLngForHandlers, 'to'));
  document.getElementById('route-from-btn').addEventListener('click', () => showRoute(clickLatLngForHandlers, 'from'));
  document.getElementById('cancel-btn').addEventListener('click', hidePanel);

  panel.classList.add('visible');
}

/* === بستن پنل === */
function hidePanel(keepMarkers = false) {
  panel.classList.remove('visible');
  if (!keepMarkers) { clearAll(); }
}

/* === دریافت موقعیت کاربر — مقدار بازگشتی {lat, lng} === */
async function getPosition(){
  if (!navigator.geolocation) throw new Error('موقعیت‌یاب پشتیبانی نمی‌شود.');
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      err => {
        let msg = 'خطا در دریافت موقعیت.';
        if (err.code === 1) msg = 'شما دسترسی به موقعیت را مسدود کرده‌اید.';
        if (err.code === 2) msg = 'سرویس موقعیت‌یاب (GPS) دستگاه شما خاموش است.';
        if (err.code === 3) msg = 'زمان درخواست به پایان رسید.';
        reject(new Error(msg));
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

/* === ثبت سرویس ورکر (اختیاری) === */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => console.log('سرویس ورکر ثبت شد.')).catch(err => console.log('خطا:', err));
  });
}
</script>

</body>
</html>
