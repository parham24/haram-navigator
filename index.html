<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>نقشه حرم</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff" />

    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Vazirmatn', Tahoma, sans-serif;
            background-color: #f0f2f5;
        }
        #app-container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; background: #eee; }
        
        #panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background-color: white;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
            box-shadow: 0 -4px
            12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateY(calc(100% - 220px)); 
            z-index: 1000;
        }
        #panel.expanded { transform: translateY(0); }
        
        #panel-handle {
            padding: 12px; text-align: center; cursor: grab; border-bottom: 1px solid #eee;
        }
        #panel-handle-bar {
            width: 40px; height: 5px; background-color: #ccc;
            border-radius: 3px; margin: 0 auto 8px;
        }
        #panel-handle-title { font-weight: bold; color: #333; }

        #panel-content { padding: 16px; max-height: calc(100vh - 80px); overflow-y: auto; }
        .controls { display: flex; flex-direction: column; gap: 12px; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        select, button {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;
            font-family: inherit; font-size: 15px; background-color: #f7f7f7;
        }
        button { background-color: #0b6; color: white; border: none; cursor: pointer; }
        #swapBtn { width: 42px; flex-shrink: 0; padding: 8px; font-size: 20px; }
        
        .place { padding: 8px; border-bottom: 1px dashed #f0f0f0; cursor:pointer; }
        .place:hover { background-color: #f9f9f9; }
        .place h4 { margin:0; font-size: 14px; }
        
        .leaflet-routing-container {
            background-color: transparent; box-shadow: none;
            line-height: 1.6;
        }
        .leaflet-routing-alternatives-container { display: none; }
        .leaflet-routing-summary { display: none; }
        .leaflet-routing-instructions { font-size: 14px; }
        
        .user-marker {
            width: 20px; height: 20px;
            background-color: #007aff;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="map"></div>
    <div id="panel">
        <div id="panel-handle">
            <div id="panel-handle-bar"></div>
            <div id="panel-handle-title">مسیریابی و جستجو</div>
        </div>
        <div id="panel-content"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
    const places = [
      { id:'sahn_enqelab', type:'صحن', name:'صحن انقلاب (عتیق)', lat:36.28805, lon:59.61560},
      { id:'sahn_azadi', type:'صحن', name:'صحن آزادی', lat:36.28860, lon:59.61630},
      { id:'sahn_jamee', type:'صحن', name:'صحن جامع رضوی', lat:36.2872, lon:59.6151},
      { id:'sahn_jomhuri', type:'صحن', name:'صحن جمهوری اسلامی', lat:36.28790, lon:59.6145},
      { id:'sahn_qods', type:'صحن', name:'صحن قدس', lat:36.28750, lon:59.61520},
      { id:'ravaq_imam_khomeini', type:'رواق', name:'رواق امام خمینی', lat:36.2876, lon:59.6155},
      { id:'bab_ol_reza', type:'باب', name:'باب‌الرضا (ورودی جنوبی)', lat:36.2868, lon:59.6150},
      { id:'golden_dome', type:'ضریح', name:'ضریح مطهر', lat:36.28805, lon:59.6157},
    ];

    const map = L.map('map', {zoomControl: false}).setView([36.28805, 59.6157], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution: '© OpenStreetMap'}).addTo(map);
    L.control.zoom({ position: 'topleft' }).addTo(map);

    let currentRouteControl = null;
    let userMarker = null;
    let watchId = null;
    const panel = document.getElementById('panel');
    const panelContent = document.getElementById('panel-content');
    const panelHandle = document.getElementById('panel-handle');
    const panelTitle = document.getElementById('panel-handle-title');
    
    panelHandle.addEventListener('click', () => panel.classList.toggle('expanded'));

    function renderInitialView() {
        panelTitle.textContent = "مسیریابی و جستجو";
        panelContent.innerHTML = `
            <div class="controls">
                <div class="control-group"><select id="start"></select><button id="swapBtn">⇄</button><select id="end"></select></div>
                <button id="go-btn">نمایش مسیر</button>
            </div><hr><div id="places-list"></div>`;
        const startSel = document.getElementById('start'), endSel = document.getElementById('end');
        addOptions(startSel); addOptions(endSel); renderPlacesList();
        document.getElementById('go-btn').addEventListener('click', showRoute);
        document.getElementById('swapBtn').addEventListener('click', () => { [startSel.value, endSel.value] = [endSel.value, startSel.value]; });
        panel.style.transform = `translateY(calc(100% - 220px))`;
        panel.classList.remove('expanded');
    }

    function addOptions(sel) {
        sel.innerHTML = '<option value="__me">موقعیت فعلی من</option>';
        places.forEach(p => {
            const o = document.createElement('option');
            o.value = p.id;
            o.textContent = p.name;
            sel.appendChild(o);
        });
    }

    function renderPlacesList() {
        const listEl = document.getElementById('places-list');
        listEl.innerHTML = places.map(p => `
            <div class="place" data-id="${p.id}">
                <h4>${p.name} <small style="color:#888;">(${p.type})</small></h4>
            </div>
        `).join('');
        
        listEl.querySelectorAll('.place').forEach(el => {
            el.addEventListener('click', () => {
                const placeId = el.dataset.id;
                document.getElementById('end').value = placeId;
                const place = places.find(p => p.id === placeId);
                map.setView([place.lat, place.lon], 19);
                panel.style.transform = `translateY(calc(100% - 220px))`;
                panel.classList.remove('expanded');
            });
        });
    }

    async function showRoute() {
        const startVal = document.getElementById('start').value;
        const endVal = document.getElementById('end').value;
        if (startVal === endVal) { displayError('مبدا و مقصد نمی‌توانند یکسان باشند.'); return; }

        clearRoute(true);
        panelTitle.textContent = "در حال محاسبه مسیر...";
        panelContent.innerHTML = `<p style="text-align:center;">لطفا منتظر بمانید...</p>`;
        panel.classList.add('expanded');

        let startPoint, endPoint;
        try {
            let userLocation = null;
            if (startVal === '__me' || endVal === '__me') {
                userLocation = await getPosition();
            }
            startPoint = (startVal === '__me') ? [userLocation.lat, userLocation.lon] : [places.find(p=>p.id===startVal).lat, places.find(p=>p.id===startVal).lon];
            endPoint = (endVal === '__me') ? [userLocation.lat, userLocation.lon] : [places.find(p=>p.id===endVal).lat, places.find(p=>p.id===endVal).lon];
        } catch (err) {
            displayError(err.message, true);
            return;
        }
      
        currentRouteControl = L.Routing.control({
            waypoints: [L.latLng(startPoint), L.latLng(endPoint)],
            addWaypoints: false,
            createMarker: function(i, waypoint, n) {
                const label = i === 0 ? 'مبدا' : 'مقصد';
                const markerColor = i === 0 ? 'green' : 'red';
                return L.marker(waypoint.latLng, { 
                    icon: L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${markerColor}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).bindPopup(`<b>${label}</b>`);
            },
            lineOptions: { styles: [{ color: '#c00', opacity: 0.9, weight: 6 }] },
            language: 'fa' // فعال‌سازی زبان فارسی
        }).addTo(map);
      
        currentRouteControl.on('routesfound', e => {
            const summary = e.routes[0].summary;
            const distance = summary.totalDistance < 1000 ? `${Math.round(summary.totalDistance).toLocaleString('fa-IR')} متر` : `${(summary.totalDistance / 1000).toLocaleString('fa-IR', {maximumFractionDigits: 1})} کیلومتر`;
            const time = Math.round(summary.totalTime / 60).toLocaleString('fa-IR');
            
            panelTitle.textContent = `مسیر: ${distance} - حدود ${time} دقیقه`;
            panelContent.innerHTML = `<button id="clear-btn" style="width:100%; margin-bottom: 12px; background-color: #777;">پاک کردن مسیر</button>`;
            document.getElementById('clear-btn').addEventListener('click', clearRoute);

            const instructionsContainer = currentRouteControl.getPlan().getContainer();
            panelContent.appendChild(instructionsContainer);
            panel.classList.add('expanded');
            
            startLiveTracking();
        });
        currentRouteControl.on('routingerror', () => displayError("مسیریابی ممکن نبود. اتصال اینترنت را بررسی کنید."));
    }

    function clearRoute(isRouting = false) {
        if (currentRouteControl) { map.removeControl(currentRouteControl); currentRouteControl = null; }
        stopLiveTracking();
        if (!isRouting) { renderInitialView(); }
    }

    function startLiveTracking() {
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition((pos) => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            if (!userMarker) {
                const userIcon = L.divIcon({ className: 'user-marker', iconSize: [20, 20] });
                userMarker = L.marker(latlng, { icon: userIcon }).addTo(map);
            }
            userMarker.setLatLng(latlng);
        }, (err) => {
            console.error("خطای ردیابی موقعیت:", err.message);
        }, { enableHighAccuracy: true });
    }

    function stopLiveTracking() {
        if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
        if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
    }
    
    async function getPosition(){
      if (!navigator.geolocation) throw { code: -1, message: 'موقعیت‌یاب در این مرورگر پشتیبانی نمی‌شود.' };
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          err => {
            let msg = 'خطا در دریافت موقعیت.';
            if (err.code === 1) msg = 'شما دسترسی به موقعیت را مسدود کرده‌اید.';
            if (err.code === 2) msg = 'سرویس موقعیت‌یاب (GPS) دستگاه شما خاموش است.';
            if (err.code === 3) msg = 'زمان درخواست به پایان رسید.';
            reject({ code: err.code, message: msg });
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    function displayError(message, isLocationError = false) {
        panelTitle.textContent = "خطا";
        panelContent.innerHTML = `<p style="color:red; text-align:center;"><strong>${message}</strong></p>`;
        if (isLocationError) {
            panelContent.innerHTML += `<div class="controls"><button id="retryBtn">تلاش مجدد</button></div>`;
            document.getElementById('retryBtn').addEventListener('click', showRoute);
        }
        panel.classList.add('expanded');
    }

    // --- فارسی‌سازی Leaflet Routing Machine ---
    L.Routing.Localization['fa'] = {
        directions: {
            N: 'شمال', S: 'جنوب', E: 'شرق', W: 'غرب',
            NE: 'شمال شرقی', SE: 'جنوب شرقی', SW: 'جنوب غربی', NW: 'شمال غربی',
            Straight: 'مستقیم ادامه دهید', TurnLeft: 'به چپ بپیچید', TurnRight: 'به راست بپیچید',
            SlightLeft: 'کمی به چپ', SlightRight: 'کمی به راست', SharpLeft: 'تند به چپ',
            SharpRight: 'تند به راست', UTurn: 'دور بزنید', Head: 'به سمت {dir} بروید',
        },
        instructions: {
            'Head': ['به سمت {dir} بروید', ' در {road}'],
            'Continue': ['ادامه دهید', ' در {road}'],
            'Turn': ['{modifier} بپیچید', ' در {road}'],
            'WaypointReached': ['به ایستگاه رسیدید'],
            'DestinationReached': ['شما به مقصد رسیدید'],
        },
        format: {
            distance: (d) => d >= 1000 ? `${(d / 1000).toLocaleString('fa-IR', {maximumFractionDigits: 1})} کیلومتر` : `${Math.round(d).toLocaleString('fa-IR')} متر`
        }
    };

    // --- اجرای اولیه برنامه ---
    renderInitialView();

    // --- ثبت سرویس ورکر ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => console.log('سرویس ورکر ثبت شد.')).catch(err => console.log('خطا در ثبت سرویس ورکر:', err));
      });
    }
</script>

</body>
</html>
